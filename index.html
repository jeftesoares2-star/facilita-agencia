<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Facilita AgÃªncia â€” ON DEMAND</title>
<meta name="theme-color" content="#06b6d4">
<style>
:root{--bg:#071228;--card:#0f172a;--accent:#06b6d4;--muted:#94a3b8;--white:#eef2ff}
body{margin:0;font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:var(--white);padding:12px}
h1{font-size:20px;margin:0 0 8px 0}
.card{background:#0f172a;padding:12px;border-radius:10px;margin-top:12px}
.btn-row{display:flex;gap:8px;justify-content:space-between;margin-bottom:10px}
.big-btn{flex:1;padding:12px;border-radius:10px;border:0;font-weight:700;font-size:17px;cursor:pointer}
.P{background:#16a34a;color:#061a10}
.M{background:#2563eb;color:#eaf2ff}
.G{background:#dc2626;color:#fff}
input, select, button {width:100%;padding:10px;border-radius:8px;border:0;background:rgba(255,255,255,0.03);color:var(--white);margin-top:8px;font-size:16px}
#reader {width:100%;border-radius:8px;margin-top:8px;background:#000;min-height:220px;display:flex;align-items:center;justify-content:center}
.small{color:var(--muted);font-size:13px;margin-top:6px}
.item{background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;margin-top:8px;display:flex;justify-content:space-between;align-items:center}
.label{font-weight:700;font-size:20px}
.muted{color:var(--muted);font-size:13px}
.row{display:flex;gap:8px}
.actions button{padding:8px;border-radius:8px;border:0;background:#1f2937;color:#fff}
#lista{max-height:260px;overflow:auto;margin-top:8px}
.danger{background:#7f1d1d;color:#fff;padding:8px;border-radius:8px}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:20px;background:#111;padding:10px 14px;border-radius:8px;box-shadow:0 4px 14px rgba(0,0,0,0.4);display:none;z-index:9999}
.status{margin-top:8px;font-size:14px;color:#cbd5e1}
.error{color:#ffb4b4;background:#3b0f0f;padding:8px;border-radius:8px;margin-top:8px}
.etiqueta-flutuante{
  position:fixed;
  top:20px;
  right:20px;
  background:var(--accent);
  color:#fff;
  padding:12px 18px;
  border-radius:10px;
  font-weight:700;
  font-size:18px;
  box-shadow:0 4px 14px rgba(0,0,0,0.4);
  z-index:9999;
  opacity:0.95;
}
</style>
</head>
<body>
<h1>ðŸ“¦ Facilita AgÃªncia â€” ON DEMAND</h1>

<div class="card">
  <div class="small">CÃ³digo do cliente (bipe ou digite)</div>
  <input id="codigo" placeholder="CÃ³digo do cliente" inputmode="numeric" maxlength="24" autofocus/>
  <div class="small">Selecione o tamanho apÃ³s bipar:</div>
  <div class="btn-row" style="margin-top:8px">
    <button id="btnP" class="big-btn P" title="Pequeno">P</button>
    <button id="btnM" class="big-btn M" title="MÃ©dio">M</button>
    <button id="btnG" class="big-btn G" title="Grande">G</button>
  </div>
  <div id="selected" class="small">Tamanho selecionado: <strong id="selText">---</strong></div>
  <button id="btnGen" class="big-btn" style="margin-top:12px;background:#0ea5a1;color:#021">Gerar etiqueta</button>
</div>

<div class="card">
  <h3 style="margin:0">ðŸ“‹ Pacotes pendentes</h3>
  <div id="lista"></div>
</div>

<div class="card">
  <h3 style="margin:0">ðŸ“‹ Pacotes entregues</h3>
  <div id="listaEntregues"></div>
</div>

<div id="toast" class="toast"></div>

<script>
const STORAGE_KEY = 'FACILITA_ONDEMAND_DB_V3';

let DB = JSON.parse(localStorage.getItem(STORAGE_KEY) || 'null');
if(!DB) DB = { registros: [], contadores:{P:0,M:0,G:0}, entregues:[] };

const codigoInput = document.getElementById('codigo');
const btnGen = document.getElementById('btnGen');
const btnP = document.getElementById('btnP');
const btnM = document.getElementById('btnM');
const btnG = document.getElementById('btnG');
const selText = document.getElementById('selText');
const lista = document.getElementById('lista');
const listaEntregues = document.getElementById('listaEntregues');
const toast = document.getElementById('toast');

let selected = null;

function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(DB)); }
function showToast(msg,ms=1200){ toast.textContent=msg; toast.style.display='block'; setTimeout(()=>toast.style.display='none',ms); }
function makeLabel(t,n){ return t + n; }
function nextNum(t){ DB.contadores[t] = (DB.contadores[t]||0)+1; return DB.contadores[t]; }

function showEtiquetaFlutuante(et){
  const div = document.createElement('div');
  div.className='etiqueta-flutuante';
  div.textContent = et;
  document.body.appendChild(div);
  setTimeout(()=>div.remove(),2000);
}

// GeraÃ§Ã£o de pacote
function allocate(code,t){
  if(!code || !t) return null;
  const existente = DB.registros.find(r=>r.codigo===code);
  if(existente){
    showToast('CÃ³digo jÃ¡ cadastrado. Para retirada, bipar novamente.');
    showEtiquetaFlutuante(existente.etiqueta);
    return existente;
  }
  const n = nextNum(t);
  const et = makeLabel(t,n);
  const rec = {codigo: code, etiqueta: et, tamanho: t, num: n};
  DB.registros.push(rec);
  save();
  refreshList();
  showEtiquetaFlutuante(et);
  return rec;
}

// Entrega do pacote
function entregar(codigo){
  const idx = DB.registros.findIndex(r=>r.codigo===codigo);
  if(idx===-1) return;
  const rec = DB.registros.splice(idx,1)[0];
  DB.entregues.push(rec);
  save();
  refreshList();
}

// Atualiza listas
function refreshList(){
  lista.innerHTML = '';
  DB.registros.slice().reverse().forEach(r=>{
    const div = document.createElement('div'); div.className='item';
    div.innerHTML = `<div><div class="label">${r.etiqueta}</div><div class="small">${r.codigo} â€¢ ${r.tamanho}</div></div>
      <div class="actions"><button onclick="entregar('${r.codigo}')">Entregar</button></div>`;
    lista.appendChild(div);
  });

  listaEntregues.innerHTML = '';
  DB.entregues.slice().reverse().forEach(r=>{
    const div = document.createElement('div'); div.className='item';
    div.innerHTML = `<div><div class="label">${r.etiqueta}</div><div class="small">${r.codigo} â€¢ ${r.tamanho}</div></div>`;
    listaEntregues.appendChild(div);
  });
}

// BotÃµes de tamanho
btnP.addEventListener('click',()=>{ selected='P'; selText.textContent='P'; });
btnM.addEventListener('click',()=>{ selected='M'; selText.textContent='M'; });
btnG.addEventListener('click',()=>{ selected='G'; selText.textContent='G'; });

// Gera etiqueta
btnGen.addEventListener('click',()=>{
  const code = codigoInput.value.trim();
  if(!code){ showToast('Digite ou bipe o cÃ³digo'); return; }
  if(!selected){ showToast('Selecione o tamanho'); return; }
  allocate(code,selected);
  codigoInput.value=''; selected=null; selText.textContent='---';
});

// Permite receber o cÃ³digo via teclado Scan/leitor externo
codigoInput.addEventListener('keypress', function(e){
  if(e.key==='Enter'){
    const code = codigoInput.value.trim();
    if(!code) return;
    // Verifica se o cÃ³digo jÃ¡ existe â†’ exibe etiqueta do pacote (retirada)
    const existente = DB.registros.find(r=>r.codigo===code);
    if(existente){
      showToast('Pacote para retirada encontrado!');
      showEtiquetaFlutuante(existente.etiqueta);
      codigoInput.value='';
      selected=null;
      selText.textContent='---';
      return;
    }
    // Se nÃ£o existe e tamanho foi selecionado â†’ cria pacote
    if(selected){
      allocate(code,selected);
      codigoInput.value=''; selected=null; selText.textContent='---';
      return;
    }
    showToast('Selecione o tamanho antes de gerar um novo pacote');
  }
});

refreshList();
</script>
</body>
</html>
