<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Facilita AgÃªncia â€” ON DEMAND</title>
<meta name="theme-color" content="#06b6d4">
<style>
  :root{--bg:#071228;--card:#0f172a;--accent:#06b6d4;--muted:#94a3b8;--white:#eef2ff}
  body{margin:0;font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:var(--white);padding:12px}
  h1{font-size:20px;margin:0 0 8px 0}
  .card{background:#0f172a;padding:12px;border-radius:10px;margin-top:12px}
  .btn-row{display:flex;gap:8px;justify-content:space-between;margin-bottom:10px}
  .big-btn{flex:1;padding:12px;border-radius:10px;border:0;font-weight:700;font-size:17px;cursor:pointer}
  .P{background:#16a34a;color:#061a10}
  .M{background:#2563eb;color:#eaf2ff}
  .G{background:#dc2626;color:#fff}
  input, select, button {width:100%;padding:10px;border-radius:8px;border:0;background:rgba(255,255,255,0.03);color:var(--white);margin-top:8px;font-size:16px}
  #lista{max-height:260px;overflow:auto;margin-top:8px}
  .small{color:var(--muted);font-size:13px;margin-top:6px}
  .item{background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;margin-top:8px;display:flex;justify-content:space-between;align-items:center}
  .label{font-weight:700;font-size:20px}
  .muted{color:var(--muted);font-size:13px}
  .row{display:flex;gap:8px}
  .actions button{padding:8px;border-radius:8px;border:0;background:#1f2937;color:#fff}
  .danger{background:#7f1d1d;color:#fff;padding:8px;border-radius:8px}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:20px;background:#111;padding:10px 14px;border-radius:8px;box-shadow:0 4px 14px rgba(0,0,0,0.4);display:none;z-index:9999}
</style>
</head>
<body>
  <h1>ðŸ“¦ Facilita AgÃªncia â€” ON DEMAND</h1>

  <div class="card">
    <div class="small">CÃ³digo do cliente</div>
    <input id="codigo" placeholder="Digite ou bipar cÃ³digo do cliente" inputmode="numeric" maxlength="24"/>
    <div class="row" style="margin-top:8px">
      <button id="btnGen" class="big-btn" style="flex:1">Gerar etiqueta</button>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0">ðŸ“‹ Registros</h3>
    <div id="lista"></div>
    <div class="row" style="margin-top:8px">
      <button id="btnResetUI" class="danger">Resetar Tudo</button>
    </div>
  </div>

  <div id="toast" class="toast"></div>

<script>
/* CONFIG */
const RESET_PASSWORD = "4608"; // altere para sua senha
const UNDO_WINDOW_MS = 10*60*1000; // 10 minutos

/* DB init */
let DB = JSON.parse(localStorage.getItem('FACILITA_ONDEMAND_DB_V1') || 'null');
if(!DB) DB = { registros: [], contadores:{P:0,M:0,G:0}, livres:{P:[],M:[],G:[]}, lastUndo:null, undoData:null };

/* UI refs */
const codigoInput = document.getElementById('codigo');
const btnGen = document.getElementById('btnGen');
const lista = document.getElementById('lista');
const toast = document.getElementById('toast');
const btnResetUI = document.getElementById('btnResetUI');

/* utils */
function save(){ localStorage.setItem('FACILITA_ONDEMAND_DB_V1', JSON.stringify(DB)); }
function showToast(msg, ms=1200){ toast.textContent = msg; toast.style.display='block'; setTimeout(()=>toast.style.display='none', ms); }
function vibrate(ms=40){ if(navigator.vibrate) navigator.vibrate(ms); }
function pad(n){ return String(n); }

/* numbering */
function nextNum(t){
  if(DB.livres[t].length){ DB.livres[t].sort((a,b)=>a-b); return DB.livres[t].shift(); }
  DB.contadores[t] = (DB.contadores[t]||0) + 1;
  return DB.contadores[t];
}

/* allocate */
function allocate(code, t){
  if(!code) return null;
  const exist = DB.registros.find(r=>r.codigo===code && !r.entregue);
  if(exist) return exist;
  const n = nextNum(t);
  const et = t + n; // etiqueta: M1, P2...
  const rec = {codigo: code, etiqueta: et, tamanho: t, num:n, entregue:false, ts:Date.now()};
  DB.registros.push(rec);
  save(); refreshList();
  showToast('Gerado ' + et); vibrate(30);
  return rec;
}

/* refresh list */
function refreshList(){
  lista.innerHTML = '';
  DB.registros.slice().reverse().forEach(r=>{
    const div = document.createElement('div'); div.className='item';
    div.innerHTML = `<div><div class="label">${r.etiqueta}</div><div class="small">${r.codigo} â€¢ ${r.tamanho} â€¢ ${r.entregue?'Entregue':'Pendente'}</div></div>
      <div class="actions"><button onclick="entregar('${r.etiqueta}')">Entregar</button></div>`;
    lista.appendChild(div);
  });
}

/* entregar */
function entregar(et){
  const rec = DB.registros.find(r=>r.etiqueta===et);
  if(!rec) return alert('NÃ£o encontrado');
  if(rec.entregue) return alert('JÃ¡ entregue');
  rec.entregue = true;
  DB.livres[rec.tamanho].push(rec.num);
  save(); refreshList(); showToast('Entregue ' + et);
}
window.entregar = entregar;

/* gerar etiqueta */
btnGen.addEventListener('click', ()=>{
  const code = codigoInput.value.trim();
  if(!code){ alert('Digite ou escaneie o cÃ³digo'); return; }
  const t = prompt('Digite o tamanho do pacote (P, M ou G)').toUpperCase();
  if(!['P','M','G'].includes(t)){ alert('Tamanho invÃ¡lido'); return; }
  allocate(code,t);
  codigoInput.value='';
});

/* reset protegido */
btnResetUI.addEventListener('click', ()=>{
  const pass = prompt('Senha para reset:');
  if(pass !== RESET_PASSWORD){ alert('Senha invÃ¡lida'); return; }
  const confirmText = prompt('Digite a frase de confirmaÃ§Ã£o: QUERO RESETAR TUDO');
  if(confirmText !== 'RESETAR'){ alert('ConfirmaÃ§Ã£o incorreta'); return; }
  DB.lastUndo = Date.now();
  DB.undoData = JSON.stringify(DB);
  localStorage.setItem('FACILITA_ONDEMAND_DB_V1_PRE_RESET', DB.undoData);
  DB = { registros: [], contadores:{P:0,M:0,G:0}, livres:{P:[],M:[],G:[]}, lastUndo: DB.lastUndo, undoData: DB.undoData };
  save(); refreshList();
  showToast('Reset feito. VocÃª tem 10 minutos para desfazer.');
  checkUndoExpiry();
});

/* undo */
function checkUndoExpiry(){
  if(!DB.lastUndo) return;
  const elapsed = Date.now() - DB.lastUndo;
  if(elapsed > UNDO_WINDOW_MS){
    DB.lastUndo = null; DB.undoData = null; localStorage.removeItem('FACILITA_ONDEMAND_DB_V1_PRE_RESET'); save();
    showToast('PerÃ­odo de desfazer expirou');
  } else {
    if(!document.getElementById('undoBtn')){
      const b = document.createElement('button'); b.id='undoBtn'; b.textContent='Desfazer Reset (10 min)'; b.style.marginTop='8px'; b.style.background='#f97316'; b.style.color='#012';
      b.onclick = function(){
        const saved = localStorage.getItem('FACILITA_ONDEMAND_DB_V1_PRE_RESET');
        if(!saved) return alert('Nenhum backup encontrado');
        try{ DB = JSON.parse(saved); DB.lastUndo = null; DB.undoData = null; localStorage.removeItem('FACILITA_ONDEMAND_DB_V1_PRE_RESET'); save(); refreshList(); alert('Dados restaurados'); b.remove(); }catch(e){ alert('Falha ao restaurar'); }
      };
      document.querySelector('.card').appendChild(b);
    }
    setTimeout(checkUndoExpiry,5000);
  }
}

/* init */
refreshList();
checkUndoExpiry();
</script>
</body>
</html>
